@extends('layout')
@section('content')

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Detail Booking #{{ $tiket->ID_TIKET }}</h4>
    <div class="text-muted small">Ringkasan booking dan pembayaran</div>
  </div>
  <a class="btn btn-outline-secondary" href="/booking">Kembali</a>
</div>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Informasi Booking</h5>

        @if($tiket->tempat && $tiket->tempat->FOTO_TEMPAT)
          <img src="{{ asset('storage/'.$tiket->tempat->FOTO_TEMPAT) }}"
               class="img-fluid rounded mb-3"
               style="max-height:260px; object-fit:cover; width:100%;"
               alt="Foto Tempat">
        @endif

        <hr>
        <div class="mb-2"><b>Tempat:</b> {{ $tiket->tempat->NAMA_TEMPAT ?? '-' }}</div>
        <div class="mb-2"><b>Tanggal:</b> {{ $tiket->TANGGAL_MULAI }} s/d {{ $tiket->TANGGAL_SELESAI }} ({{ $nights }} malam)</div>
        <div class="mb-2"><b>Jumlah Orang:</b> {{ $tiket->JUMLAH_ORANG }}</div>

        <hr>
        <div class="mb-1"><b>Total Tempat:</b> Rp{{ number_format($totalTempat) }}</div>
        <div class="mb-1"><b>Total Addon:</b> Rp{{ number_format($totalAddon) }}</div>
        <div class="fs-5 mt-2"><b>Grand Total:</b> Rp{{ number_format($grandTotal) }}</div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="card-title">Addon</h5>
        <hr>
        @if($tiket->addons->count() === 0)
          <div class="text-muted">Tidak ada addon.</div>
        @else
          <ul class="mb-0">
            @foreach($tiket->addons as $a)
              <li>{{ $a->NAMA_BARANG }} — Rp{{ number_format((float)$a->HARGA_BARANG) }} x {{ $a->QTY ?? 1 }}</li>
            @endforeach
          </ul>
        @endif
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Pembayaran</h5>
        <hr>

        @php
          $st = $tiket->pembayaran->STATUS_BAYAR ?? 'BELUM ADA';
        @endphp

        <div class="mb-2">
          Status:
          <span class="badge
            @if($st==='LUNAS') bg-success
            @elseif($st==='PENDING') bg-warning text-dark
            @elseif($st==='GAGAL') bg-danger
            @elseif($st==='EXPIRED') bg-secondary
            @else bg-dark @endif">
            {{ $st }}
          </span>
        </div>

        @if(!$tiket->pembayaran)
          <a class="btn btn-success w-100" href="/booking/{{ $tiket->ID_TIKET }}/pay">Buat Pembayaran</a>
        @else
          <a class="btn btn-primary w-100" href="/payment/{{ $tiket->pembayaran->ID_PEMBAYARAN }}/pay">Buka Halaman Bayar</a>
        @endif

        @if($st !== 'LUNAS')
          <form action="{{ route('booking.cancel', ['id' => $tiket->ID_TIKET]) }}" method="POST" class="mt-2" onsubmit="return confirm('Cancel booking ini?');">
            @csrf
            <button type="submit" class="btn btn-outline-danger w-100">Cancel Booking</button>
          </form>
        @endif

        @if($st==='LUNAS')
          <div class="alert alert-success mt-3 mb-0">
            Pembayaran sukses.
          </div>
        @endif
      </div>
    </div>

    {{-- ✅ QR TIKET (muncul hanya jika LUNAS) --}}
@if($st === 'LUNAS' && !empty($tiket->QR_TOKEN))
  @php
    $targetUrl = route('admin.scan.show', ['token' => $tiket->QR_TOKEN]);
  @endphp

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">QR Tiket</h5>
          <div class="text-muted small">
            Tunjukkan QR ini ke pegawai untuk discan saat masuk lokasi.
          </div>
        </div>
        <span class="badge bg-success">VALID</span>
      </div>

      <div class="mt-3 text-center">
        {!! \SimpleSoftwareIO\QrCode\Facades\QrCode::format('svg')->size(260)->generate($targetUrl) !!}
      </div>

      <div class="small text-muted mt-3">
      </div>

      <div class="mt-2">
        <a class="btn btn-outline-secondary w-100" target="_blank" href="{{ $targetUrl }}">
          Buka Link Verifikasi tiket
        </a>
      </div>
    </div>
  </div>
@elseif($st === 'LUNAS' && empty($tiket->QR_TOKEN))
  <div class="alert alert-warning mt-3">
    Pembayaran sudah LUNAS, tapi QR_TOKEN belum terbentuk.
    Pastikan PaymentController generate QR_TOKEN saat status LUNAS.
  </div>
@endif

  </div>
</div>

@endsection
